name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    name: Build and Create Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: composer:v2

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20'

    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    # Build saga-manager-core (foundation plugin)
    - name: Build saga-manager-core
      run: |
        cd saga-manager-core
        composer install --no-dev --optimize-autoloader --no-progress --no-scripts
        cd ..

        # Create WordPress-compliant ZIP
        # Root must contain single directory matching plugin slug
        mkdir -p build/saga-manager-core

        # Copy only production files
        cp saga-manager-core/saga-manager-core.php build/saga-manager-core/
        cp saga-manager-core/uninstall.php build/saga-manager-core/
        cp saga-manager-core/composer.json build/saga-manager-core/
        cp -r saga-manager-core/src build/saga-manager-core/
        cp -r saga-manager-core/assets build/saga-manager-core/

        # Include optional directories if they exist
        if [ -d "saga-manager-core/languages" ]; then
          cp -r saga-manager-core/languages build/saga-manager-core/
        fi

        if [ -d "saga-manager-core/vendor" ]; then
          cp -r saga-manager-core/vendor build/saga-manager-core/
        fi

        # Create ZIP from build directory
        cd build
        zip -r ../saga-manager-core-${{ steps.get_version.outputs.VERSION }}.zip saga-manager-core
        cd ..
        rm -rf build

    # Build saga-manager (main backend plugin)
    - name: Build saga-manager
      run: |
        cd saga-manager
        composer install --no-dev --optimize-autoloader --no-progress --no-scripts
        cd ..

        # Create WordPress-compliant ZIP
        mkdir -p build/saga-manager

        # Copy only production files
        cp saga-manager/saga-manager.php build/saga-manager/
        cp saga-manager/uninstall.php build/saga-manager/
        cp saga-manager/composer.json build/saga-manager/
        cp -r saga-manager/src build/saga-manager/
        cp -r saga-manager/assets build/saga-manager/

        # Include vendor if exists
        if [ -d "saga-manager/vendor" ]; then
          cp -r saga-manager/vendor build/saga-manager/
        fi

        # Include languages if exists
        if [ -d "saga-manager/languages" ]; then
          cp -r saga-manager/languages build/saga-manager/
        fi

        # Create ZIP
        cd build
        zip -r ../saga-manager-${{ steps.get_version.outputs.VERSION }}.zip saga-manager
        cd ..
        rm -rf build

    # Build saga-manager-display (frontend plugin)
    - name: Build saga-manager-display
      run: |
        cd saga-manager-display

        # Install and build frontend assets (Gutenberg blocks)
        if [ -f "package.json" ]; then
          npm install --no-audit --no-fund
          npm run build
          echo "=== Build output ==="
          ls -la build/ 2>/dev/null || echo "No build directory created"
          ls -la build/blocks/ 2>/dev/null || echo "No build/blocks directory"
        fi

        # Install PHP deps
        composer install --no-dev --optimize-autoloader --no-progress --no-scripts
        cd ..

        # Create WordPress-compliant ZIP
        mkdir -p build/saga-manager-display

        # Copy only production files
        cp saga-manager-display/saga-manager-display.php build/saga-manager-display/
        cp saga-manager-display/composer.json build/saga-manager-display/
        cp -r saga-manager-display/src build/saga-manager-display/
        cp -r saga-manager-display/assets build/saga-manager-display/
        cp -r saga-manager-display/templates build/saga-manager-display/

        # Include built blocks (compiled JS/CSS from npm build)
        if [ -d "saga-manager-display/build/blocks" ]; then
          mkdir -p build/saga-manager-display/build
          cp -r saga-manager-display/build/blocks build/saga-manager-display/build/
          echo "=== Included built blocks ==="
          ls -la build/saga-manager-display/build/blocks/
        else
          echo "WARNING: No built blocks found - blocks may not work!"
        fi

        # Include languages if exists
        if [ -d "saga-manager-display/languages" ]; then
          cp -r saga-manager-display/languages build/saga-manager-display/
        fi

        # Include vendor if exists
        if [ -d "saga-manager-display/vendor" ]; then
          cp -r saga-manager-display/vendor build/saga-manager-display/
        fi

        # Create ZIP
        cd build
        zip -r ../saga-manager-display-${{ steps.get_version.outputs.VERSION }}.zip saga-manager-display
        cd ..
        rm -rf build

    # Verify ZIP structure
    - name: Verify ZIP structure
      run: |
        echo "=== saga-manager-core ZIP structure ==="
        unzip -l saga-manager-core-${{ steps.get_version.outputs.VERSION }}.zip | head -30

        echo ""
        echo "=== saga-manager ZIP structure ==="
        unzip -l saga-manager-${{ steps.get_version.outputs.VERSION }}.zip | head -30

        echo ""
        echo "=== saga-manager-display ZIP structure ==="
        unzip -l saga-manager-display-${{ steps.get_version.outputs.VERSION }}.zip | head -30

        # Verify WordPress compliance - each ZIP should have single root folder
        echo ""
        echo "=== Verifying WordPress compliance ==="

        for zip in saga-manager-core saga-manager saga-manager-display; do
          # Count unique top-level directories (filter out headers, get path column, extract first component)
          ROOT_DIRS=$(unzip -l ${zip}-${{ steps.get_version.outputs.VERSION }}.zip | tail -n +4 | head -n -2 | awk '{print $NF}' | cut -d'/' -f1 | sort -u | grep -v '^-*$' | grep -v '^$' | wc -l)
          echo "Debug: ${zip} has ${ROOT_DIRS} root directories"
          if [ "$ROOT_DIRS" -eq "1" ]; then
            echo "âœ“ ${zip}: Single root directory (WordPress compliant)"
          else
            echo "âœ— ${zip}: Multiple root directories (NOT WordPress compliant)"
            # Show what directories were found
            unzip -l ${zip}-${{ steps.get_version.outputs.VERSION }}.zip | tail -n +4 | head -n -2 | awk '{print $NF}' | cut -d'/' -f1 | sort -u
            exit 1
          fi
        done

    - name: Create Release Notes
      id: release_notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        ## Saga Manager Release ${{ steps.get_version.outputs.VERSION }}

        ### ðŸ“¦ Installation

        **Required:**
        1. Download `saga-manager-core-${{ steps.get_version.outputs.VERSION }}.zip` (database layer)
        2. Download `saga-manager-${{ steps.get_version.outputs.VERSION }}.zip` (admin interface)

        **Optional:**
        3. Download `saga-manager-display-${{ steps.get_version.outputs.VERSION }}.zip` (frontend display)

        **Install via WordPress:**
        1. Go to Plugins â†’ Add New â†’ Upload Plugin
        2. Upload and activate **Saga Manager Core** first
        3. Upload and activate **Saga Manager** (backend admin)
        4. Optionally upload and activate **Saga Manager Display** (frontend)

        ### ðŸŽ¯ Plugin Architecture

        | Plugin | Purpose |
        |--------|---------|
        | **saga-manager-core** | Database abstraction, adapters (WordPress, PDO, InMemory) |
        | **saga-manager** | REST API, admin UI, CQRS application layer |
        | **saga-manager-display** | Shortcodes, Gutenberg blocks, widgets |

        ### âœ… Requirements

        - PHP 8.2 or higher
        - WordPress 6.0 or higher
        - MariaDB 11.4+ / MySQL 8.0+

        ### ðŸ“š Documentation

        See the [GitHub repository](https://github.com/calounx/sagas) for:
        - Installation Guide
        - Architecture Overview
        - API Reference

        ---
        ðŸ¤– Built with Claude Code
        EOF

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          saga-manager-core-${{ steps.get_version.outputs.VERSION }}.zip
          saga-manager-${{ steps.get_version.outputs.VERSION }}.zip
          saga-manager-display-${{ steps.get_version.outputs.VERSION }}.zip
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-packages
        path: |
          saga-manager-core-${{ steps.get_version.outputs.VERSION }}.zip
          saga-manager-${{ steps.get_version.outputs.VERSION }}.zip
          saga-manager-display-${{ steps.get_version.outputs.VERSION }}.zip
        retention-days: 90
